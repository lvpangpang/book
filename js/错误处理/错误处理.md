### 错误处理

#### 1.常见错误类型
1. AJAX 请求异常（重点）
2. Promise 异常(重点)
3. JS 语法错误、代码异常
4. 静态资源加载异常
5. Iframe 异常
6. 跨域 Script error
7. 崩溃和卡顿  


#### 2.注意点
1. 永远不要在 macrotask(setTimeout之类) 队列中抛出异常（throw Error），在 macrotask 级别回调中永远使用 reject。macrotask 队列脱离了运行上下文环境，异常无法被当前作用域捕获。不过 microtask 中抛出的异常可以被捕获，说明 microtask 队列并没有离开当前作用域。  
2. promise 内部的错误不会冒泡出来，而是被 promise 吃掉了，只有通过 promise.catch 才可以捕获

```
function main1() {
  try {
    new Promise(() => {
      throw new Error('promise1 error')
    })
  } catch(e) {
    console.log(e.message);
  }
}

function main2() {
  try {
    Promise.reject('promise2 error');
  } catch(e) {
    console.log(e.message);
  }
}
```

#### 3.面试题
1. 以下代码执行结果  
```
new Promise((resolve, reject) => {
  setTimeout(() => {
    throw Error('macrotask 中的异常')
  }, 1000)
})
```
2. 封装一个请求处理函数
```
export default function request(config) {
  const {
    isLoading=false,
    method='get',
    url,
    data,
    params,
    businessErrorHandle=()=>{},
    networkErrorHandle=()=>{}
  } = config;
  // 参数处理
  if(params) {
    Object.keys(params).map((item) => {
      params[item] = !params[item] ? undefined : params[item]; 
    });
  }
  return new Promise((reslove, reject) => {
    if(isLoading) {
      Toast.loading('请求中...', 0);
    }
    axios({
      headers: {
        token: localStorage.getItem('token')
      },
      method,
      url: DOMAIN() + url,
      data,
      params,
      timeout: 10000
    }).then((data) => {
      const result = data.data;
      const { code } = result;
      // 正常业务
      if(code===200) {
        reslove(result.data);
        // 未登录
      } else if (code===999) {
        window.location.replace('#/login');
      } else {
        if(!businessErrorHandle) {
          Toast.fail(result.msg || '未知错误');
        } else {
          reject(result);
        }
      }
    }).catch((err) => {
      if(!networkErrorHandle) {
        Toast.fail('服务端异常，请稍后再试');
      } else {
        reject(err);
      }
    }).finally(() => {
      if(isLoading) {
        Toast.hide();
      }
    })
  });
}
```

