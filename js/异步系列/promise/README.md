### Promise

> å‡½æ•°æ‰§è¡Œæ˜¯ä¸€ä¸ªâ€œå…¥æ ˆ/å‡ºæ ˆâ€çš„è¿‡ç¨‹ã€‚å½“æˆ‘ä»¬åœ¨ A å‡½æ•°é‡Œè°ƒç”¨ B å‡½æ•°çš„æ—¶å€™ï¼ŒJS å¼•æ“Žå°±ä¼šå…ˆæŠŠ A åŽ‹åˆ°æ ˆé‡Œï¼Œç„¶åŽå†æŠŠ B åŽ‹åˆ°æ ˆé‡Œï¼›B è¿è¡Œç»“æŸåŽï¼Œå‡ºæ ˆï¼Œç„¶åŽç»§ç»­æ‰§è¡Œ Aï¼›A ä¹Ÿè¿è¡Œå®Œæ¯•åŽï¼Œå‡ºæ ˆï¼Œæ ˆå·²æ¸…ç©ºï¼Œè¿™æ¬¡è¿è¡Œç»“æŸã€‚

#### å¼‚æ­¥å›žè°ƒä¼ ç»Ÿåšæ³•çš„ç¼ºç‚¹
1. åµŒå¥—å±‚æ¬¡å¾ˆæ·±ï¼Œéš¾ä»¥ç»´æŠ¤
2. ä»£ç éš¾ä»¥å¤ç”¨
3. å †æ ˆè¢«ç ´åï¼Œæ— æ³•æ­£å¸¸æ£€ç´¢ï¼Œä¹Ÿæ— æ³•æ­£å¸¸ä½¿ç”¨ try/catch/throw
4. å¤šä¸ªå¼‚æ­¥è®¡ç®—åŒæ—¶è¿›è¡Œï¼Œæ— æ³•é¢„æœŸå®Œæˆé¡ºåºï¼Œå¿…é¡»å€ŸåŠ©å¤–å±‚ä½œç”¨åŸŸçš„å˜é‡ï¼Œæœ‰è¯¯æ“ä½œé£Žé™©

#### Tips
1. .resolve() .reject() ä¸ä¼šè‡ªåŠ¨ returnã€‚
2. Promise é‡Œå¿…é¡» .resolve() .reject() throw err æ‰ä¼šæ”¹å˜çŠ¶æ€ï¼Œ.then() ä¸éœ€è¦ã€‚
3. resolve() åªä¼šè¿”å›žä¸€ä¸ªå€¼ï¼Œè¿”å›žå¤šä¸ªå€¼è¯·ç”¨æ•°ç»„æˆ–å¯¹è±¡
4. æ°¸è¿œä¸è¦åœ¨ macrotask(setTimeoutä¹‹ç±») é˜Ÿåˆ—ä¸­æŠ›å‡ºå¼‚å¸¸ï¼ˆthrow Errorï¼‰ï¼Œåœ¨ macrotask çº§åˆ«å›žè°ƒä¸­æ°¸è¿œä½¿ç”¨ rejectã€‚macrotask é˜Ÿåˆ—è„±ç¦»äº†è¿è¡Œä¸Šä¸‹æ–‡çŽ¯å¢ƒï¼Œå¼‚å¸¸æ— æ³•è¢«å½“å‰ä½œç”¨åŸŸæ•èŽ·ã€‚ä¸è¿‡ microtask ä¸­æŠ›å‡ºçš„å¼‚å¸¸å¯ä»¥è¢«æ•èŽ·ï¼Œè¯´æ˜Ž microtask é˜Ÿåˆ—å¹¶æ²¡æœ‰ç¦»å¼€å½“å‰ä½œç”¨åŸŸã€‚  
5. promise å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå†’æ³¡å‡ºæ¥ï¼Œè€Œæ˜¯è¢« promise åƒæŽ‰äº†ï¼Œåªæœ‰é€šè¿‡ promise.catch æ‰å¯ä»¥æ•èŽ·
6. Promiseçš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚(è§3.1)
7. .thenå’Œ.catchéƒ½ä¼šè¿”å›žä¸€ä¸ªæ–°çš„Promiseã€‚(ä¸Šé¢çš„ðŸ‘†1.4è¯æ˜Žäº†)
8. catchä¸ç®¡è¢«è¿žæŽ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•èŽ·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯ã€‚(è§3.2)
9. åœ¨Promiseä¸­ï¼Œè¿”å›žä»»æ„ä¸€ä¸ªéž promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œä¾‹å¦‚return 2ä¼šè¢«åŒ…è£…ä¸ºreturn Promise.resolve(2)ã€‚
10. Promise çš„ .then æˆ–è€… .catch å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡, ä½†å¦‚æžœPromiseå†…éƒ¨çš„çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåŽç»­æ¯æ¬¡è°ƒç”¨.thenæˆ–è€….catchçš„æ—¶å€™éƒ½ä¼šç›´æŽ¥æ‹¿åˆ°è¯¥å€¼ã€‚(è§3.5)
11. .then æˆ–è€… .catch ä¸­ return ä¸€ä¸ª error å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åŽç»­çš„ .catch æ•èŽ·ã€‚(è§3.6)
12. .then æˆ– .catch è¿”å›žçš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªçŽ¯ã€‚(è§3.7)
13. .then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éžå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ ã€‚(è§3.8)
14. .thenæ–¹æ³•æ˜¯èƒ½æŽ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ï¼Œå†æŸäº›æ—¶å€™ä½ å¯ä»¥è®¤ä¸ºcatchæ˜¯.thenç¬¬äºŒä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ã€‚(è§3.9)
15. .finallyæ–¹æ³•ä¹Ÿæ˜¯è¿”å›žä¸€ä¸ªPromiseï¼Œä»–åœ¨Promiseç»“æŸçš„æ—¶å€™ï¼Œæ— è®ºç»“æžœä¸ºresolvedè¿˜æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡Œé‡Œé¢çš„å›žè°ƒå‡½æ•°ã€‚

#### é¢è¯•é¢˜
1. ä»¥ä¸‹ä»£ç æ‰§è¡Œç»“æžœ  
```
new Promise((resolve, reject) => {
  setTimeout(() => {
    throw Error('macrotask ä¸­çš„å¼‚å¸¸')
  }, 1000)
})
```
2. å°è£…ä¸€ä¸ªè¯·æ±‚å¤„ç†å‡½æ•°
```
// è¯·æ±‚
export default function request(config) {
  const {
    isLoading=false,
    method='get',
    url,
    data,
    params,
    handleBusinessError=false,
    handleNetworkError=false
  } = config;
  // å‚æ•°å¤„ç†
  if(params) {
    Object.keys(params).map((item) => {
      params[item] = !params[item] ? undefined : params[item]; 
    });
  }
  return new Promise((reslove, reject) => {
    if(isLoading) {
      Toast.loading('è¯·æ±‚ä¸­...', 0);
    }
    axios({
      headers: {
        token: localStorage.getItem('token')
      },
      method,
      url: DOMAIN() + url,
      data,
      params,
      timeout: 10000
    }).then((data) => {
      const result = data.data;
      const { code } = result;
      // æ­£å¸¸ä¸šåŠ¡
      if(code===200) {
        reslove(result.data);
        // æœªç™»å½•
      } else if (code===999) {
        window.location.replace('#/login');
      } else {
        if(!handleBusinessError) {
          Toast.fail(result.msg || 'æœªçŸ¥é”™è¯¯');
        } else {
          reject(result);
        }
      }
    }).catch((err) => {
      if(!handleNetworkError) {
        Toast.fail('æœåŠ¡ç«¯å¼‚å¸¸ï¼Œè¯·ç¨åŽå†è¯•');
      } else {
        reject(err);
      }
    }).finally(() => {
      if(isLoading) {
        Toast.hide();
      }
    })
  });
}
```

